# Ghost C2 - CI/CD Pipeline
# Build automatique du serveur, agent et web UI

name: Build C2

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # Build Teamserver (Go)
  build-server:
    name: Build Teamserver
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: server/go.sum

      - name: Build Linux
        run: |
          cd server
          go build -ldflags="-s -w" -o ../bin/server_linux ./cmd/main.go

      - name: Build Windows
        run: |
          cd server
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o ../bin/server_windows.exe ./cmd/main.go

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: teamserver
          path: bin/server_*

  # Build Agent (C cross-compile with MinGW)
  build-agent:
    name: Build Agent
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install MinGW
        run: sudo apt-get update && sudo apt-get install -y mingw-w64

      - name: Build Agent EXE
        run: |
          cd agent
          make exe

      - name: Build Agent DLL
        run: |
          cd agent
          make dll

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agent
          path: agent/bin/ghost.*

  # Build Web UI (React + Vite)
  build-web:
    name: Build Web UI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: cd web && npm ci

      - name: Build
        run: cd web && npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-ui
          path: web/dist/

  # Release (on version tags)
  release:
    name: Create Release
    needs: [build-server, build-agent, build-web]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            teamserver/*
            agent/*
            web-ui/*
          generate_release_notes: true
